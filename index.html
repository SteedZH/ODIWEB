<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Map</title>
        <link rel="stylesheet" type="text/css" href="map.css">
        <script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
    </head>
    <body>
        <script>
            var width = window.innerWidth;
            var height = window.innerHeight;
            var centered;

            var svg = d3.select("body")
                .append("svg")
                .attr("width", 1200)
                .attr("height", 800)
                .attr("transform", "translate(600,100)")
                .attr("viewBox", "0,0,1900,500")
                .append("g");
            
            var projection = d3.geo.mercator()
                                .center([0,0])
                                .scale(300)
                                .translate([width/2, height/2]);
            
            var path = d3.geo.path()
                        .projection(projection);
            
            var color = d3.scale.category20();

            var world = svg.append("g");
                        
            d3.json("world.json", function(error, root){

                if(error)
                    return console.error(error);
                console.log(root.features);
                world.selectAll("path")
                    .data(root.features)
                    .enter()
                    .append("path")
                    // .attr("d",path)
                    .on("click", clickToZoom)
                    // .attr("strole", "#000")
                    // .attr("stroke-width", 1)
                    .attr("fill", function(d,i){
				        return color(i);
                    })
                    .attr("d", path )
                    .on("mouseover",function(d,i){
                        d3.select(this)
                            .attr("fill","yellow");
                    })
                    .on("mouseout",function(d,i){
                        d3.select(this)
                            .attr("fill",color(i));
                    });
                
                    d3.csv("refine.csv", function(data) {
                        console.log(data)
                    return {
                        country: data["country_long"],
                        capacity: +data["capacity_mw"],
                        latitude: +data["latitude"],
                        longitude: +data["longitude"],
                        position: [data["longitude"], data["latitude"]],
                        fuel: data["fuel1"]
                    };
                },

                function(error, data) {
                    if (error){
                        console.log("ERROR: ");
                        console.log(error);
                        return;
                    }
                console.log(data);
                
                var tooltip = d3.select("body")
                    .append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0.0)
                
                var position = svg.append("g")
                position.selectAll("circle")
                    .data(data)
                    .enter()
                    // .append("g")
                    // .attr("class", "position")
                    .append("circle")
                    .attr("r",3)
                    .attr("transform",function(d){
                        var coordinates = projection([d.longitude, d.latitude]);
                        return "translate("+ coordinates[0] + "," + coordinates[1] +")"
                    })
                    .on("mouseover", function(d){
                                d3.select(this)
                                    .classed("active", true);
                                console.log("just had a mouseover", d.country);
                                tooltip.html(d.country+"<br/>"+"Capacity: "+d.capacity+"<br/>"+"fuel: "+d.fuel+"<br/>"+"Longitude: "+d.longitude+"<br/>"+"latitude " +d.latitude+"<br/>")
                                    .style("left",(d3.event.pageX) + "px")
                                    .style("top",(d3.event.pageY+20) + "px")
                                    .style("opacity",1.0)
                        })
                    .on("mousemove", function(d){
                            tooltip.style("left", (d3.event.pageX)+"px")
                                   .style("top", (d3.event.pageY+20)+"px")
                        })
                    .on("mouseout", function(d){
                                tooltip.style("opacity", 0.0)
                                d3.select(this)
                                    .classed("active", false)
                        });
                }
            );
            });
            
            function clickToZoom(d){
                var x, y, k;

                if(d && centered !== d){
                    var centroid =path.centroid(d);
                    x = centroid[0];
                    y = centroid[1];
                    k = 4;
                    centered = d;
                }
                else{
                    x = width/2;
                    y = height/2;
                    k = 1;
                    centered = null;
                }
                svg.selectAll("g")
                    .classed("active", centered && function(d){
                        return d === centered;
                    });
                svg.transition()
                    .duration(750)
                    .attr("transform", "translate(" + width /2 +"," + height/2+")scale("+k+")translate("+ -x +","+ -y +")")
                    .style("stroke-width", 1.5/k +"px");
            }
        </script>
    </body>
</html>
